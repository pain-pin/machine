250607
15:41:34
n
computer
/home/n/machine/journal/by_session/computer/n

utilise une image codee en dur notement a la balise [_HERE_] 
ci apres ce que dit yiaho pour le script a la la balise [_THERE_]

Conclusion
Le script et la configuration Cloud-init font essentiellement la même chose : préparer un système Raspberry Pi avec un nom d'hôte spécifique, activer SSH, configurer un utilisateur, et établir une connexion WiFi. Cloud-init est une méthode plus moderne et souvent préférée pour déployer des configurations sur des instances cloud en raison de sa simplicité et de sa capacité à s'adapter à différents environnements. Si vous avez besoin d'une aide supplémentaire ou de modifications spécifiques, n'hésitez pas à demander !

Explication du Script Bash

Définition du nom d'hôte

Cela vérifie si un fichier spécifique (imager_custom) existe pour configurer le nom d'hôte. Si oui, il l'utilise ; sinon, il modifie directement /etc/hostname et /etc/hosts.
Configuration de l'utilisateur : bash FIRSTUSER=`getent passwd 1000 | cut -d: -f1` FIRSTUSERHOME=`getent passwd 1000 | cut -d: -f6` ...

Cela récupère le premier utilisateur (ID 1000) et son répertoire personnel.
Activation de SSH et ajout de la clé SSH : bash if [ -f /usr/lib/raspberrypi-sys-mods/imager_custom ]; then /usr/lib/raspberrypi-sys-mods/imager_custom enable_ssh -k 'clé-ssh' else install -o "$FIRSTUSER" -m 700 -d "$FIRSTUSERHOME/.ssh" install -o "$FIRSTUSER" -m 600 <(printf "clé-ssh") "$FIRSTUSERHOME/.ssh/authorized_keys" echo 'PasswordAuthentication no' >>/etc/ssh/sshd_config systemctl enable ssh fi

Ceci active SSH et configure la clé publique pour l'authentification. Il désactive également l'authentification par mot de passe.
Configuration de l'utilisateur et du mot de passe : bash echo "$FIRSTUSER:"'$5$uDbzRIx/9F$AFbcXsICBNBewZBwwWckUpW.YuScgFYOI4uiuxvcgYA' | chpasswd -e ...

Cela configure le mot de passe pour l'utilisateur.
Configuration du WiFi : bash if [ -f /usr/lib/raspberrypi-sys-mods/imager_custom ]; then /usr/lib/raspberrypi-sys-mods/imager_custom set_wlan 'SSID' 'clé' else cat >/etc/wpa_supplicant/wpa_supplicant.conf <<'WPAEOF' country=FR ... WPAEOF111111111111111


250607-13:41:51-n@computer-~/Downloads-
=> rpi-imager 
Opening in existing browser session.
Available disk space for caching: 5 GB
Unmounting: "/dev/sdb"
Unmounted "/org/freedesktop/UDisks2/block_devices/sdb2" successfully
Telemetry done. cURL status code = 0 info sent = "url=https%3A%2F%2Freleases.libreelec.tv%2FLibreELEC-RPi4.aarch64-12.0.2.img.gz&os=LibreELEC&image=LibreELEC%20%28RPi4%29&imagerVersion=1.8.5&imagerOsType=debian&imagerOsVersion=12&imagerOsArch=x86_64&imagerLocale=en_US"
Unmounted "/org/freedesktop/UDisks2/block_devices/sdb1" successfully
BLKDISCARD not supported
Zeroing out first and last MB of drive
Done zeroing out start and end of drive. Took 0 seconds
Image URL: "https://releases.libreelec.tv/LibreELEC-RPi4.aarch64-12.0.2.img.gz"
Received header: "HTTP/1.1 302 Found"
Received header: "Server: nginx/1.18.0 (Ubuntu)"
Received header: "Date: Sat, 07 Jun 2025 11:45:15 GMT"
Received header: "Content-Type: text/html; charset=utf-8"
Received header: "Content-Length: 0"
Received header: "Connection: keep-alive"
Received header: "Cache-Control: private, no-cache"
Received header: "Link: <https://ftp.nluug.nl/pub/mediaplayer/libreelec/LibreELEC-RPi4.aarch64-12.0.2.img.gz>; rel=duplicate; pri=1; geo=nl"
Received header: "Location: https://ftp.halifax.rwth-aachen.de/libreelec/LibreELEC-RPi4.aarch64-12.0.2.img.gz"
Received header: ""
Received header: "HTTP/2 200"
Received header: "server: nginx/1.22.1"
Received header: "date: Sat, 07 Jun 2025 11:45:16 GMT"
Received header: "content-type: application/octet-stream"
Received header: "content-length: 152438767"
Received header: "last-modified: Mon, 20 Jan 2025 02:41:33 GMT"
Received header: "accept-ranges: bytes"
Received header: ""
Download done in 47 seconds
Hash of uncompressed image: "107c07686f6d764f5a47c3bbb50c1304522299de6db80d37d62849f5fb6a9e1c"
Done writing cache file
Write done in 145 seconds
Verify hash: "107c07686f6d764f5a47c3bbb50c1304522299de6db80d37d62849f5fb6a9e1c"
Verify done in 55.29 seconds
Writing first block (which we skipped at first)
Deactivating auto-mount for "/dev/sdb"
Ejecting drive:  "Mass-Storage-Device-121220160204"
qrc:/main.qml:795:9: QML QQuickItem: Binding loop detected for property "height"
qrc:/main.qml:795:9: QML QQuickItem: Binding loop detected for property "height"
qrc:/main.qml:795:9: QML QQuickItem: Binding loop detected for property "height"
qrc:/main.qml:795:9: QML QQuickItem: Binding loop detected for property "height"
qrc:/main.qml:795:9: QML QQuickItem: Binding loop detected for property "height"
qrc:/main.qml:795:9: QML QQuickItem: Binding loop detected for property "height"
qrc:/main.qml:795:9: QML QQuickItem: Binding loop detected for property "height"
qrc:/main.qml:795:9: QML QQuickItem: Binding loop detected for property "height"
qrc:/main.qml:795:9: QML QQuickItem: Binding loop detected for property "height"
qrc:/main.qml:795:9: QML QQuickItem: Binding loop detected for property "height"
qrc:/main.qml:795:9: QML QQuickItem: Binding loop detected for property "height"
qrc:/main.qml:795:9: QML QQuickItem: Binding loop detected for property "height"
qrc:/main.qml:795:9: QML QQuickItem: Binding loop detected for property "height"
qrc:/main.qml:795:9: QML QQuickItem: Binding loop detected for property "height"
Custom config.txt entries: ""
Custom cmdline.txt entries: " cfg80211.ieee80211_regdom=FR"
[_THERE_] Custom firstuse.sh: "#!/bin/bash\n\nset +e\n\nCURRENT_HOSTNAME=`cat /etc/hostname | tr -d \" \\t\\n\\r\"`\nif [ -f /usr/lib/raspberrypi-sys-mods/imager_custom ]; then\n   /usr/lib/raspberrypi-sys-mods/imager_custom set_hostname bOx\nelse\n   echo bOx >/etc/hostname\n   sed -i \"s/127.0.1.1.*$CURRENT_HOSTNAME/127.0.1.1\\tbOx/g\" /etc/hosts\nfi\nFIRSTUSER=`getent passwd 1000 | cut -d: -f1`\nFIRSTUSERHOME=`getent passwd 1000 | cut -d: -f6`\nif [ -f /usr/lib/raspberrypi-sys-mods/imager_custom ]; then\n   /usr/lib/raspberrypi-sys-mods/imager_custom enable_ssh -k 'ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQClOYTc6uySRH6LEvhDiq1kK1EgLnLvY0vAH7NmcJavcVs3Ftd9Me0QxrNAsXzJr84fYJ5mcFznZNQZM1iqlBZTFLWgfKQzPIB5Sb8G7IP+bVmx/FDR+Qoo2DKff0aqHfJHSw6cfZ6Madz1OBBbUa+sQKoK+x2KH79FD8NyhqucIzdzm74vFIdj6/5Mx5WWv5QoksnNFVvNqyyR3XuINF2RgMYDgXftiJfwh/+xZIGoIOwfiB3BpryIDYD9ddzSj4Y8oKkGWtkdIkrnf6PWXWPciS2mQ0AMsf5yPi/19gTegxNCAkS1cmFQjPWCt4qvzCpI48ehNMhclunmHEJ90XMwiElkOPPXW4ibSsZbyADFCMZ2QR9DeN02JB5J95QN4v0ohTnL+zlsIgGyB3+nbZI2a1Pg9XfhAC63Psk/JYeN8V/LTPKL/4NVIrTZT0xi7+wFrWtffsIAPEY5PC2vDAhCA931cA2jnDMx3AnrM9aIBukkPbdmdrQdAYrJR43RTEs= n@computer'\nelse\n   install -o \"$FIRSTUSER\" -m 700 -d \"$FIRSTUSERHOME/.ssh\"\n   install -o \"$FIRSTUSER\" -m 600 <(printf \"ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQClOYTc6uySRH6LEvhDiq1kK1EgLnLvY0vAH7NmcJavcVs3Ftd9Me0QxrNAsXzJr84fYJ5mcFznZNQZM1iqlBZTFLWgfKQzPIB5Sb8G7IP+bVmx/FDR+Qoo2DKff0aqHfJHSw6cfZ6Madz1OBBbUa+sQKoK+x2KH79FD8NyhqucIzdzm74vFIdj6/5Mx5WWv5QoksnNFVvNqyyR3XuINF2RgMYDgXftiJfwh/+xZIGoIOwfiB3BpryIDYD9ddzSj4Y8oKkGWtkdIkrnf6PWXWPciS2mQ0AMsf5yPi/19gTegxNCAkS1cmFQjPWCt4qvzCpI48ehNMhclunmHEJ90XMwiElkOPPXW4ibSsZbyADFCMZ2QR9DeN02JB5J95QN4v0ohTnL+zlsIgGyB3+nbZI2a1Pg9XfhAC63Psk/JYeN8V/LTPKL/4NVIrTZT0xi7+wFrWtffsIAPEY5PC2vDAhCA931cA2jnDMx3AnrM9aIBukkPbdmdrQdAYrJR43RTEs= n@computer\") \"$FIRSTUSERHOME/.ssh/authorized_keys\"\n   echo 'PasswordAuthentication no' >>/etc/ssh/sshd_config\n   systemctl enable ssh\nfi\nif [ -f /usr/lib/userconf-pi/userconf ]; then\n   /usr/lib/userconf-pi/userconf 'n' '$5$uDbzRIx/9F$AFbcXsICBNBewZBwwWckUpW.YuScgFYOI4uiuxvcgYA'\nelse\n   echo \"$FIRSTUSER:\"'$5$uDbzRIx/9F$AFbcXsICBNBewZBwwWckUpW.YuScgFYOI4uiuxvcgYA' | chpasswd -e\n   if [ \"$FIRSTUSER\" != \"n\" ]; then\n      usermod -l \"n\" \"$FIRSTUSER\"\n      usermod -m -d \"/home/n\" \"n\"\n      groupmod -n \"n\" \"$FIRSTUSER\"\n      if grep -q \"^autologin-user=\" /etc/lightdm/lightdm.conf ; then\n         sed /etc/lightdm/lightdm.conf -i -e \"s/^autologin-user=.*/autologin-user=n/\"\n      fi\n      if [ -f /etc/systemd/system/getty@tty1.service.d/autologin.conf ]; then\n         sed /etc/systemd/system/getty@tty1.service.d/autologin.conf -i -e \"s/$FIRSTUSER/n/\"\n      fi\n      if [ -f /etc/sudoers.d/010_pi-nopasswd ]; then\n         sed -i \"s/^$FIRSTUSER /n /\" /etc/sudoers.d/010_pi-nopasswd\n      fi\n   fi\nfi\nif [ -f /usr/lib/raspberrypi-sys-mods/imager_custom ]; then\n   /usr/lib/raspberrypi-sys-mods/imager_custom set_wlan 'TP-Link_548A' '2537037311b53d184eea47f2bef2c13b7f2e0b4a9cb2abea025014b0eda804bd' 'FR'\nelse\ncat >/etc/wpa_supplicant/wpa_supplicant.conf <<'WPAEOF'\ncountry=FR\nctrl_interface=DIR=/var/run/wpa_supplicant GROUP=netdev\nap_scan=1\n\nupdate_config=1\nnetwork={\n\tssid=\"TP-Link_548A\"\n\tpsk=2537037311b53d184eea47f2bef2c13b7f2e0b4a9cb2abea025014b0eda804bd\n}\n\nWPAEOF\n   chmod 600 /etc/wpa_supplicant/wpa_supplicant.conf\n   rfkill unblock wifi\n   for filename in /var/lib/systemd/rfkill/*:wlan ; do\n       echo 0 > $filename\n   done\nfi\nif [ -f /usr/lib/raspberrypi-sys-mods/imager_custom ]; then\n   /usr/lib/raspberrypi-sys-mods/imager_custom set_keymap 'us'\n   /usr/lib/raspberrypi-sys-mods/imager_custom set_timezone 'Europe/Paris'\nelse\n   rm -f /etc/localtime\n   echo \"Europe/Paris\" >/etc/timezone\n   dpkg-reconfigure -f noninteractive tzdata\ncat >/etc/default/keyboard <<'KBEOF'\nXKBMODEL=\"pc105\"\nXKBLAYOUT=\"us\"\nXKBVARIANT=\"\"\nXKBOPTIONS=\"\"\n\nKBEOF\n   dpkg-reconfigure -f noninteractive keyboard-configuration\nfi\nrm -f /boot/firstrun.sh\nsed -i 's| systemd.run.*||g' /boot/cmdline.txt\nexit 0\n"

Cloudinit: "hostname: bOx\nmanage_etc_hosts: true\npackages:\n- avahi-daemon\napt:\n  conf: |\n    Acquire {\n      Check-Date \"false\";\n    };\n\nusers:\n- name: n\n  groups: users,adm,dialout,audio,netdev,video,plugdev,cdrom,games,input,gpio,spi,i2c,render,sudo\n  shell: /bin/bash\n  lock_passwd: false\n  [_HERE_]passwd: $5$uDbzRIx/9F$AFbcXsICBNBewZBwwWckUpW.YuScgFYOI4uiuxvcgYA\n  ssh_authorized_keys:\n    - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQClOYTc6uySRH6LEvhDiq1kK1EgLnLvY0vAH7NmcJavcVs3Ftd9Me0QxrNAsXzJr84fYJ5mcFznZNQZM1iqlBZTFLWgfKQzPIB5Sb8G7IP+bVmx/FDR+Qoo2DKff0aqHfJHSw6cfZ6Madz1OBBbUa+sQKoK+x2KH79FD8NyhqucIzdzm74vFIdj6/5Mx5WWv5QoksnNFVvNqyyR3XuINF2RgMYDgXftiJfwh/+xZIGoIOwfiB3BpryIDYD9ddzSj4Y8oKkGWtkdIkrnf6PWXWPciS2mQ0AMsf5yPi/19gTegxNCAkS1cmFQjPWCt4qvzCpI48ehNMhclunmHEJ90XMwiElkOPPXW4ibSsZbyADFCMZ2QR9DeN02JB5J95QN4v0ohTnL+zlsIgGyB3+nbZI2a1Pg9XfhAC63Psk/JYeN8V/LTPKL/4NVIrTZT0xi7+wFrWtffsIAPEY5PC2vDAhCA931cA2jnDMx3AnrM9aIBukkPbdmdrQdAYrJR43RTEs= n@computer\n  sudo: ALL=(ALL) NOPASSWD:ALL\n\n\ntimezone: Europe/Paris\nruncmd:\n- localectl set-x11-keymap \"us\" pc105\n- setupcon -k --force || true\n\n\n"

Available disk space for caching: 5 GB
Low disk space. Not caching files to disk.
Unmounting: "/dev/sdb"
Unmounted "/org/freedesktop/UDisks2/block_devices/sdb" successfully
Telemetry done. cURL status code = 0 info sent = "url=https%3A%2F%2Fdownloads.raspberrypi.com%2Fraspios_full_arm64%2Fimages%2Fraspios_full_arm64-2025-05-13%2F2025-05-13-raspios-bookworm-arm64-full.img.xz&os=Raspberry%20Pi%20OS%20%28other%29&image=Raspberry%20Pi%20OS%20Full%20%2864-bit%29&imagerVersion=1.8.5&imagerOsType=debian&imagerOsVersion=12&imagerOsArch=x86_64&imagerLocale=en_US"
BLKDISCARD not supported
Zeroing out first and last MB of drive
Done zeroing out start and end of drive. Took 0 seconds
Image URL: "https://downloads.raspberrypi.com/raspios_full_arm64/images/raspios_full_arm64-2025-05-13/2025-05-13-raspios-bookworm-arm64-full.img.xz"
Received header: "HTTP/2 200"
Received header: "date: Sat, 07 Jun 2025 13:13:48 GMT"
Received header: "server: Apache"
Received header: "vary: User-Agent"
Received header: "last-modified: Tue, 13 May 2025 00:32:07 GMT"
Received header: "etag: \"c288158c-634f98ffb84a8\""
Received header: "accept-ranges: bytes"
Received header: "content-length: 3263698316"
Received header: "content-type: application/x-xz"
Received header: ""
HTTP connection lost. Time: 1749302152
Received header: "HTTP/2 206"
Received header: "date: Sat, 07 Jun 2025 13:17:18 GMT"
Received header: "server: Apache"
Received header: "vary: User-Agent"
Received header: "last-modified: Tue, 13 May 2025 00:32:07 GMT"
Received header: "etag: \"c288158c-634f98ffb84a8\""
Received header: "accept-ranges: bytes"
Received header: "content-length: 3132197413"
Received header: "content-range: bytes 131500903-3263698315/3263698316"
Received header: "content-type: application/x-xz"
Received header: ""
HTTP connection lost. Time: 1749303320
HTTP connection lost. Time: 1749303380
HTTP connection lost. Time: 1749303440
HTTP connection lost. Time: 1749303500
HTTP connection lost. Time: 1749303560
HTTP connection lost. Time: 1749303621

