#!/usr/bin/bash

DIR=/tmp/bs
BSKY_API="https://bsky.social/xrpc"
# --- Usage ---
usage() {
    echo "Usage: $0 [user] --text 'message' [--media /path/to/file]"
    exit 1
}

# --- Parse arguments ---
TEXT=""
MEDIA=""
while [[ $# -gt 0 ]]; do
    case "$1" in
        --text) TEXT="$2"; shift 2 ;;
        --media) MEDIA="$2"; shift 2 ;;
        *) USER="$1"; shift ;;
    esac
done
USER=${USER:-"$(cat $DIR/last)"}
TOKEN_FILE="$DIR/$USER.tok"

# --- Load token ---
if [[ ! -f "$TOKEN_FILE" ]]; then
    echo "Token file not found: $TOKEN_FILE"
    exit 1
fi
ACCESS_TOKEN=$(jq -r '.accessJwt' "$TOKEN_FILE")


[[ -n "$TEXT" ]] || usage

# --- Post text only ---
if [[ -z "$MEDIA" ]]; then
    RESPONSE=$(curl -s -w "%{http_code}" -o /tmp/bsky_resp.json \
        -X POST "$BSKY_API/com.atproto.repo.createRecord" \
        -H "Authorization: Bearer $ACCESS_TOKEN" \
        -H "Content-Type: application/json" \
        -d "{\"repo\":\"$(jq -r '.did' "$TOKEN_FILE")\",\"collection\":\"app.bsky.feed.post\",\"record\":{\"text\":\"$TEXT\"}}")
    STATUS=$RESPONSE
    cat /tmp/bsky_resp.json
else
    # --- Upload media ---
    UPLOAD=$(curl -s -w "%{http_code}" -o /tmp/bsky_upload.json \
        -X POST "$BSKY_API/com.atproto.repo.uploadBlob" \
        -H "Authorization: Bearer $ACCESS_TOKEN" \
        -F "file=@$MEDIA")
    STATUS=$UPLOAD
    BLOB=$(jq -r '.blob.ref' /tmp/bsky_upload.json)
    [[ "$BLOB" == "null" ]] && { echo "Media upload failed"; exit 1; }

    # --- Post text with media ---
    RESPONSE=$(curl -s -w "%{http_code}" -o /tmp/bsky_resp.json \
        -X POST "$BSKY_API/com.atproto.repo.createRecord" \
        -H "Authorization: Bearer $ACCESS_TOKEN" \
        -H "Content-Type: application/json" \
        -d "{\"repo\":\"$(jq -r '.did' "$TOKEN_FILE")\",\"collection\":\"app.bsky.feed.post\",\"record\":{\"text\":\"$TEXT\",\"embed\":{\"$type\":\"app.bsky.embed.images\",\"images\":[{\"image\":{\"ref\":\"$BLOB\"}}]}}}")
    STATUS=$RESPONSE
    cat /tmp/bsky_resp.json
fi

# --- Status check ---
if [[ "$STATUS" == "200" || "$STATUS" == "201" ]]; then
    echo "Post successful"
else
    echo "Post failed (HTTP $STATUS)"
fi

