#!/usr/bin/bash

. /svr/usr/bin/includes/bsky

USER_FULL=$(cat "$LAST_USER_DIR" 2>/dev/null)
TOKEN_FILE="$TOKEN_DIR/$USER_FULL.tok"
TEXT="$1"

if [ -z "$TEXT" ]; then
    echo "Usage: $(basename "$0") 'text to post'"
    exit 1
fi

if [ ! -f "$TOKEN_FILE" ]; then
    echo "Token file not found: $TOKEN_FILE"
    exit 1
fi

ACCESS_TOKEN=$(jq -r '.accessJwt' "$TOKEN_FILE")
if [ -z "$ACCESS_TOKEN" ] || [ "$ACCESS_TOKEN" = "null" ]; then
    echo "Invalid token in $TOKEN_FILE"
    exit 1
fi

curl -s -X POST https://bsky.social/xrpc/com.atproto.repo.createRecord \
  -H "Authorization: Bearer $ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d "{
    \"repo\": \"$USER_FULL\",
    \"collection\": \"app.bsky.feed.post\",
    \"record\": {
      \"text\": \"$TEXT\",
      \"createdAt\": \"$(date -u +"%Y-%m-%dT%H:%M:%SZ")\"
    }
  }"

echo

