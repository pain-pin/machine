#!/bin/bash
set -eux

# from vm to make a shared folder
# mount -t 9p -o trans=virtio hostshare /mnt

# --- Configurable defaults ---
IMG=${1:-arch.qcow2}
SIZE=${2:-4G}
RAM=${3:-2G}
CPUS=${4:-2}
ISO_URL="https://mirror.arizona.edu/archlinux/iso/latest/archlinux-x86_64.iso"
ISO=${5:-$(basename $ISO_URL)}
SHARE=${6:-$PWD/share}

# --- Setup ---
mkdir -p "$SHARE"
[ -f "$ISO" ] || wget "$ISO_URL"
[ -f "$IMG" ] || qemu-img create -f qcow2 "$IMG" "$SIZE"

# --- Optional install script ---
# Drop any file named install.sh in ./share to execute it inside the VM later:
# e.g. `bash /mnt/share/install.sh` after mounting

# --- Run QEMU with graphics + shared folder ---
qemu-system-x86_64 \
  -enable-kvm \
  -m "$RAM" \
  -cpu host \
  -smp "$CPUS" \
  -boot d \
  -cdrom "$ISO" \
  -drive file="$IMG",format=qcow2 \
  -device virtio-vga \
  -display default,show-cursor=on \
  -nic user,model=virtio,hostfwd=tcp::2222-:22,dns=9.9.9.9 \
  -virtfs local,id=share,path="$SHARE",security_model=none,mount_tag=hostshare

