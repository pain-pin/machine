#!/usr/bin/bash

. $BIN_DIR/includes/bsky
USER=${1:-"ni-bot"}
PASSWD=${2:-"passwd_dflt"}
TOKEN_DIR="/tmp/bs"
USER_FULL="$USER.$DFLT_CUSTOM_DOMAIN"
TOKEN_FILE=$TOKEN_DIR/$USER_FULL.tok
mkdir $TOKEN_DIR

if [ "$#" -eq 2 ] ; then
	curl -X POST https://bsky.social/xrpc/com.atproto.server.createSession \
  -H 'Content-Type: application/json' \
  -d "{'identifier': '$USER_FULL', 'password': '$PASSWD'}" \
  >> $TOKEN_FILE
	echo $USER_FULL > $LAST_USER_DIR

	exit 0
fi

if [ "$#" -eq 1 ] ; then
	ACCESS_TOKEN=$(jq -r '.accessJwt' $TOKEN_FILE)
	if [[ ! -f "$TOKEN_FILE" ]]; then
	    echo "Token file not found: $TOKEN_FILE"
	    exit 1
	fi
	CURL_OUT=$(curl -s -o /dev/null -w "%{http_code}" \
	    -H "Authorization: Bearer $ACCESS_TOKEN" \
	    https://bsky.social/xrpc/com.atproto.server.getSession)
	if [[ "$CURL_OUT" -eq 200 ]]; then
	    echo "Token is valid"
		echo $USER_FULL > $LAST_USER_DIR
	    exit 0
	elif [[ "$CURL_OUT" -eq 0 ]]; then
	    echo "HTTP Succcess"
		echo $USER_FULL > $LAST_USER_DIR
	    exit 1
	else
	    echo "Token is invalid or expired (HTTP $CURL_OUT)"
	    exit 1
	fi


fi

exit 0

